import e from"cors";import t from"fs";import r from"path";import n from"os";import o,{randomUUID as s}from"crypto";import i,{Router as a}from"express";import c from"nodemailer";import l from"dotenv";import{fileURLToPath as p}from"url";var d,u,g,f,E,v,m={exports:{}},h={name:"dotenv",version:"16.4.5",description:"Loads environment variables from .env file",main:"lib/main.js",types:"lib/main.d.ts",exports:{".":{types:"./lib/main.d.ts",require:"./lib/main.js",default:"./lib/main.js"},"./config":"./config.js","./config.js":"./config.js","./lib/env-options":"./lib/env-options.js","./lib/env-options.js":"./lib/env-options.js","./lib/cli-options":"./lib/cli-options.js","./lib/cli-options.js":"./lib/cli-options.js","./package.json":"./package.json"},scripts:{"dts-check":"tsc --project tests/types/tsconfig.json",lint:"standard","lint-readme":"standard-markdown",pretest:"npm run lint && npm run dts-check",test:"tap tests/*.js --100 -Rspec","test:coverage":"tap --coverage-report=lcov",prerelease:"npm test",release:"standard-version"},repository:{type:"git",url:"git://github.com/motdotla/dotenv.git"},funding:"https://dotenvx.com",keywords:["dotenv","env",".env","environment","variables","config","settings"],readmeFilename:"README.md",license:"BSD-2-Clause",devDependencies:{"@definitelytyped/dtslint":"^0.0.133","@types/node":"^18.11.3",decache:"^4.6.1",sinon:"^14.0.1",standard:"^17.0.0","standard-markdown":"^7.1.0","standard-version":"^9.5.0",tap:"^16.3.0",tar:"^6.1.11",typescript:"^4.8.4"},engines:{node:">=12"},browser:{fs:!1}};function D(){if(d)return m.exports;d=1;const e=t,s=r,i=n,a=o,c=h.version,l=/(?:^|^)\s*(?:export\s+)?([\w.-]+)(?:\s*=\s*?|:\s+?)(\s*'(?:\\'|[^'])*'|\s*"(?:\\"|[^"])*"|\s*`(?:\\`|[^`])*`|[^#\r\n]+)?\s*(?:#.*)?(?:$|$)/gm;function p(e){console.log(`[dotenv@${c}][DEBUG] ${e}`)}function u(e){return e&&e.DOTENV_KEY&&e.DOTENV_KEY.length>0?e.DOTENV_KEY:process.env.DOTENV_KEY&&process.env.DOTENV_KEY.length>0?process.env.DOTENV_KEY:""}function g(e,t){let r;try{r=new URL(t)}catch(e){if("ERR_INVALID_URL"===e.code){const e=new Error("INVALID_DOTENV_KEY: Wrong format. Must be in valid uri format like dotenv://:key_1234@dotenvx.com/vault/.env.vault?environment=development");throw e.code="INVALID_DOTENV_KEY",e}throw e}const n=r.password;if(!n){const e=new Error("INVALID_DOTENV_KEY: Missing key part");throw e.code="INVALID_DOTENV_KEY",e}const o=r.searchParams.get("environment");if(!o){const e=new Error("INVALID_DOTENV_KEY: Missing environment part");throw e.code="INVALID_DOTENV_KEY",e}const s=`DOTENV_VAULT_${o.toUpperCase()}`,i=e.parsed[s];if(!i){const e=new Error(`NOT_FOUND_DOTENV_ENVIRONMENT: Cannot locate environment ${s} in your .env.vault file.`);throw e.code="NOT_FOUND_DOTENV_ENVIRONMENT",e}return{ciphertext:i,key:n}}function f(t){let r=null;if(t&&t.path&&t.path.length>0)if(Array.isArray(t.path))for(const n of t.path)e.existsSync(n)&&(r=n.endsWith(".vault")?n:`${n}.vault`);else r=t.path.endsWith(".vault")?t.path:`${t.path}.vault`;else r=s.resolve(process.cwd(),".env.vault");return e.existsSync(r)?r:null}function E(e){return"~"===e[0]?s.join(i.homedir(),e.slice(1)):e}const v={configDotenv:function(t){const r=s.resolve(process.cwd(),".env");let n="utf8";const o=Boolean(t&&t.debug);t&&t.encoding?n=t.encoding:o&&p("No encoding is specified. UTF-8 is used by default");let i,a=[r];if(t&&t.path)if(Array.isArray(t.path)){a=[];for(const e of t.path)a.push(E(e))}else a=[E(t.path)];const c={};for(const r of a)try{const o=v.parse(e.readFileSync(r,{encoding:n}));v.populate(c,o,t)}catch(e){o&&p(`Failed to load ${r} ${e.message}`),i=e}let l=process.env;return t&&null!=t.processEnv&&(l=t.processEnv),v.populate(l,c,t),i?{parsed:c,error:i}:{parsed:c}},_configVault:function(e){var t;t="Loading env from encrypted .env.vault",console.log(`[dotenv@${c}][INFO] ${t}`);const r=v._parseVault(e);let n=process.env;return e&&null!=e.processEnv&&(n=e.processEnv),v.populate(n,r,e),{parsed:r}},_parseVault:function(e){const t=f(e),r=v.configDotenv({path:t});if(!r.parsed){const e=new Error(`MISSING_DATA: Cannot parse ${t} for an unknown reason`);throw e.code="MISSING_DATA",e}const n=u(e).split(","),o=n.length;let s;for(let e=0;e<o;e++)try{const t=g(r,n[e].trim());s=v.decrypt(t.ciphertext,t.key);break}catch(t){if(e+1>=o)throw t}return v.parse(s)},config:function(e){if(0===u(e).length)return v.configDotenv(e);const t=f(e);return t?v._configVault(e):(r=`You set DOTENV_KEY but you are missing a .env.vault file at ${t}. Did you forget to build it?`,console.log(`[dotenv@${c}][WARN] ${r}`),v.configDotenv(e));var r},decrypt:function(e,t){const r=Buffer.from(t.slice(-64),"hex");let n=Buffer.from(e,"base64");const o=n.subarray(0,12),s=n.subarray(-16);n=n.subarray(12,-16);try{const e=a.createDecipheriv("aes-256-gcm",r,o);return e.setAuthTag(s),`${e.update(n)}${e.final()}`}catch(e){const t=e instanceof RangeError,r="Invalid key length"===e.message,n="Unsupported state or unable to authenticate data"===e.message;if(t||r){const e=new Error("INVALID_DOTENV_KEY: It must be 64 characters long (or more)");throw e.code="INVALID_DOTENV_KEY",e}if(n){const e=new Error("DECRYPTION_FAILED: Please check your DOTENV_KEY");throw e.code="DECRYPTION_FAILED",e}throw e}},parse:function(e){const t={};let r,n=e.toString();for(n=n.replace(/\r\n?/gm,"\n");null!=(r=l.exec(n));){const e=r[1];let n=r[2]||"";n=n.trim();const o=n[0];n=n.replace(/^(['"`])([\s\S]*)\1$/gm,"$2"),'"'===o&&(n=n.replace(/\\n/g,"\n"),n=n.replace(/\\r/g,"\r")),t[e]=n}return t},populate:function(e,t,r={}){const n=Boolean(r&&r.debug),o=Boolean(r&&r.override);if("object"!=typeof t){const e=new Error("OBJECT_REQUIRED: Please check the processEnv argument being passed to populate");throw e.code="OBJECT_REQUIRED",e}for(const r of Object.keys(t))Object.prototype.hasOwnProperty.call(e,r)?(!0===o&&(e[r]=t[r]),n&&p(!0===o?`"${r}" is already defined and WAS overwritten`:`"${r}" is already defined and was NOT overwritten`)):e[r]=t[r]}};return m.exports.configDotenv=v.configDotenv,m.exports._configVault=v._configVault,m.exports._parseVault=v._parseVault,m.exports.config=v.config,m.exports.decrypt=v.decrypt,m.exports.parse=v.parse,m.exports.populate=v.populate,m.exports=v,m.exports}v||(v=1,D().config(Object.assign({},function(){if(g)return u;g=1;const e={};return null!=process.env.DOTENV_CONFIG_ENCODING&&(e.encoding=process.env.DOTENV_CONFIG_ENCODING),null!=process.env.DOTENV_CONFIG_PATH&&(e.path=process.env.DOTENV_CONFIG_PATH),null!=process.env.DOTENV_CONFIG_DEBUG&&(e.debug=process.env.DOTENV_CONFIG_DEBUG),null!=process.env.DOTENV_CONFIG_OVERRIDE&&(e.override=process.env.DOTENV_CONFIG_OVERRIDE),null!=process.env.DOTENV_CONFIG_DOTENV_KEY&&(e.DOTENV_KEY=process.env.DOTENV_CONFIG_DOTENV_KEY),u=e}(),function(){if(E)return f;E=1;const e=/^dotenv_config_(encoding|path|debug|override|DOTENV_KEY)=(.+)$/;return f=function(t){return t.reduce((function(t,r){const n=r.match(e);return n&&(t[n[1]]=n[2]),t}),{})}}()(process.argv))));
/**
 * @copyright Copyright (c) 2025 Christian Silfang
 */
const _=p(import.meta.url),N=r.dirname(_),y=r.join(N,"..","data"),O=r.join(y,"registrations.ndjson");t.existsSync(y)||t.mkdirSync(y,{recursive:!0});const b=async(e,r)=>{const n={id:s(),type:e,timestamp:(new Date).toISOString(),...r},o=JSON.stringify(n)+"\n";try{return await t.promises.appendFile(O,o),n}catch(e){throw console.error("Fehler beim Speichern der Daten:",e),new Error("Daten konnten nicht gespeichert werden.")}},T=async()=>{try{const e=await t.promises.readFile(O,"utf-8");return e.split("\n").filter((e=>e.length>0)).map((e=>JSON.parse(e)))}catch(e){if("ENOENT"===e.code)return[];throw console.error("Fehler beim Lesen der Daten:",e),new Error("Daten konnten nicht gelesen werden.")}};
/**
 * @copyright Copyright (c) 2025 Christian Silfang
 */
l.config();const V=process.env.SMTP_SERVER||"",I=parseInt(process.env.SMTP_PORT||"465",10),w=process.env.SENDER_MAIL||"",j=process.env.SENDER_PW||"",A=e=>e?e.split(/[,;]+/).map((e=>e.trim())).filter((e=>e.length>0)):[],R=e=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e),S=a();S.post("/send_email",(async(e,t)=>{try{const r=e.body;await b("email-contact",r);const{to:n,subject:o,text:s,cc:i,bcc:a,from:l}=r,p=A(n),d=A(i),u=A(a);if(0===p.length||!p.every(R))return void t.status(400).json({error:"Ungültige Empfänger-E-Mail-Adresse."});if(d.length>0&&!d.every(R))return void t.status(400).json({error:"Ungültige CC-E-Mail-Adresse."});if(u.length>0&&!u.every(R))return void t.status(400).json({error:"Ungültige BCC-E-Mail-Adresse."});const g=c.createTransport({host:V,port:I,secure:!0,auth:{user:w,pass:j},tls:{rejectUnauthorized:!1},socketTimeout:1e4,connectionTimeout:1e4}),f={from:l||w,to:p.join(","),cc:d.length?d.join(","):void 0,bcc:u.length?u.join(","):void 0,subject:o,html:s},E=await g.sendMail(f);console.log("E-Mail gesendet:",E.messageId),t.status(200).json({message:"E-Mail erfolgreich gesendet",messageId:E.messageId,to:p,cc:d,bcc:u,subject:o})}catch(e){console.error("Fehler beim Senden der E-Mail:",e),t.status(500).json({error:"Fehler beim Senden der E-Mail",details:e.message||e.toString()})}}));
/**
 * @copyright Copyright (c) 2025 Christian Silfang
 */
const F=e=>{const t=new Date(e),r=new Date;let n=r.getFullYear()-t.getFullYear();const o=r.getMonth()-t.getMonth();return(o<0||0===o&&r.getDate()<t.getDate())&&n--,n},M=a();M.post("/register",(async(e,t)=>{try{const r=e.body,{trip:n,additionalText:o,participants:s}=r;if(!n||!s||!Array.isArray(s)||0===s.length)return void t.status(400).json({error:"Die Reise und mindestens ein Teilnehmer sind erforderlich."});const{availableBoardings:i,...a}=n,c=s.map((e=>({...a,...e,age:F(e.birthday),additionalText:o}))),l=[];for(const e of c){const t=await b("trip-registration",e);l.push(t)}t.status(201).json({message:"Registrierung erfolgreich gespeichert.",data:l})}catch(e){console.error("Fehler bei der Erstellung der Registrierung:",e),t.status(500).json({error:"Fehler bei der Verarbeitung Ihrer Anfrage.",details:e.message})}})),M.get("/register",(async(e,t)=>{try{const e=await T();t.status(200).json(e)}catch(e){console.error("Fehler beim Abrufen der Registrierungen:",e),t.status(500).json({error:"Fehler bei der Verarbeitung Ihrer Anfrage.",details:e.message})}})),M.get("/register/:id",(async(e,t)=>{try{const{id:r}=e.params,n=await(async e=>(await T()).find((t=>t.id===e))||null)(r);n?t.status(200).json(n):t.status(404).json({message:"Registrierung nicht gefunden."})}catch(e){console.error("Fehler beim Abrufen der Registrierung:",e),t.status(500).json({error:"Fehler bei der Verarbeitung Ihrer Anfrage.",details:e.message})}})),
/**
 * @copyright Copyright (c) 2025 Christian Silfang
 */
l.config();const $=process.env.SMTP_SERVER||"",x=parseInt(process.env.SMTP_PORT||"465",10),Y=process.env.SENDER_MAIL||"",C=process.env.SENDER_PW||"",k=i();k.use(i.json()),k.use(e()),k.use("/api",S),k.use("/api",M);k.listen(3e3,(()=>{console.log("Server läuft auf Port 3000"),console.log(`SMTP Server ${$}`),console.log(`SMTP Port ${x}`),console.log(`Absender Mail-Adresse ${Y}`),console.log(`Absender Mail-Password ${C}`)}));
//# sourceMappingURL=index.js.map
