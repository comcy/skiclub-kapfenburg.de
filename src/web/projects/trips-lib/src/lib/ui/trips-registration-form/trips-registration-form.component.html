<div class="content-container">
    <form class="form" [formGroup]="tripRegisterForm" (submit)="submit()">
        <div class="instrcution-label">
            @if (!hasPreselectedData) {
                <div class="instruction-label">
                    <label class="instruction-number">1</label>
                    <label class="instruction-text">Ausfahrt wählen</label>
                </div>
            }
        </div>
        <mat-form-field class="full-width" appearance="fill">
            <mat-label>Ausfahrt</mat-label>
            <mat-select formControlName="trip">
                @for (trip of additionalData; track $index) {
                    <mat-option [value]="trip">{{ trip.date }} - {{ trip.destination }}</mat-option>
                }
            </mat-select>
        </mat-form-field>

        @if (!hasPreselectedData) {
            <div class="instruction-label">
                <label class="instruction-number" [ngClass]="!firstPartSelected ? 'disabled' : ''">2</label>
                <label class="instruction-text" [ngClass]="!firstPartSelected ? 'disabled' : ''"
                    >Weitere Daten eingeben</label
                >
            </div>
        }

        <div class="participants-container">
            <div formArrayName="participants">
                @for (participant of participants().controls; track $index; let i = $index) {
                    <div [formGroupName]="i" class="participant-group">
                        <div class="participant-header">
                            <h4>
                                Teilnehmer {{ i + 1 }}
                                @if (i === 0) {
                                    (Ansprechpartner)
                                } @else {
                                    (Zusatzperson)
                                }
                                @if (participant.get('isCollapsed')?.value) {
                                    <span>
                                        - {{ participant.get('firstName')?.value }}
                                        {{ participant.get('lastName')?.value }}
                                    </span>
                                }
                            </h4>
                            <div>
                                @if (i > 0) {
                                    <button
                                        mat-icon-button
                                        (click)="removeParticipant(i)"
                                        class="remove-participant-btn"
                                    >
                                        <mat-icon>delete</mat-icon>
                                    </button>
                                }
                                <button mat-icon-button (click)="toggleCollapse(i)">
                                    <mat-icon>
                                        {{
                                            participant.get('isCollapsed')?.value
                                                ? 'keyboard_arrow_down'
                                                : 'keyboard_arrow_up'
                                        }}
                                    </mat-icon>
                                </button>
                            </div>
                        </div>
                        <div class="participant-form" [class.collapsed]="isParticipantCollapsed(i)">
                            @if ((breakpointObserver.handsetBreakpoint$ | async) === false) {
                                <div>
                                    <table class="full-width" cellspacing="0">
                                        <tr>
                                            <td>
                                                <mat-form-field class="full-width" appearance="fill">
                                                    <mat-label>Vorname</mat-label>
                                                    <input matInput formControlName="firstName" />
                                                </mat-form-field>
                                            </td>
                                            <td>
                                                <mat-form-field class="full-width" appearance="fill">
                                                    <mat-label>Nachname</mat-label>
                                                    <input matInput formControlName="lastName" />
                                                </mat-form-field>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            } @else {
                                <div>
                                    <mat-form-field class="full-width" appearance="fill">
                                        <mat-label>Vorname</mat-label>
                                        <input matInput formControlName="firstName" />
                                    </mat-form-field>

                                    <mat-form-field class="full-width" appearance="fill">
                                        <mat-label>Nachname</mat-label>
                                        <input matInput formControlName="lastName" />
                                    </mat-form-field>
                                </div>
                            }

                            <mat-form-field class="full-width" appearance="fill">
                                <mat-label>Geburtstag</mat-label>
                                <input matInput [matDatepicker]="picker" formControlName="birthday" />
                                <mat-hint>DD.MM.YYYY</mat-hint>
                                <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                                <mat-datepicker #picker></mat-datepicker>
                            </mat-form-field>

                            <mat-form-field class="full-width" appearance="fill">
                                <mat-label>E-Mail</mat-label>
                                <input matInput formControlName="email" />
                            </mat-form-field>

                            <mat-form-field class="full-width" appearance="fill">
                                <mat-label>Telefonnummer</mat-label>
                                <input matInput formControlName="phone" />
                            </mat-form-field>

                            <mat-form-field class="full-width" appearance="fill">
                                <mat-label>Zustieg</mat-label>
                                @if (boardingList$ | async; as boardingList) {
                                    <mat-select formControlName="boarding">
                                        @for (boarding of boardingList; track $index) {
                                            <mat-option [value]="boarding">{{ boarding }}</mat-option>
                                        }
                                    </mat-select>
                                }
                            </mat-form-field>
                        </div>
                    </div>
                }
            </div>

            <div class="button-wrapper">
                <button matFab (click)="addParticipant()">
                    <mat-icon>person_add</mat-icon>
                </button>
            </div>
        </div>

        <mat-form-field class="full-width" appearance="fill">
            <mat-label>Zusatzinformationen</mat-label>
            <textarea matInput formControlName="additionalText" rows="8"></textarea>
        </mat-form-field>

        @if (!tripRegisterForm.valid && tripRegisterForm.touched) {
            <mat-error> Bitte alle erfordelichen Felder (*) ausfüllen. </mat-error>
        }

        <button mat-raised-button color="primary" type="submit" [disabled]="isSubmitDisabled()">Absenden</button>

        @if (true) {
            <hr />
            <h3>Debug Output</h3>
            <pre>
        Form Value: {{ tripRegisterForm.value | json }}
        Form Status: {{ tripRegisterForm.status | json }}
        Form Errors: {{ tripRegisterForm.errors | json }}
    </pre
            >
            <h4>Controls</h4>
            @for (control of tripRegisterForm.controls | keyvalue; track control.key) {
                <div>
                    <strong>{{ control.key }}</strong>
                    - Valid: {{ control.value.valid }} - Touched: {{ control.value.touched }} - Errors:
                    {{ control.value.errors | json }}
                </div>
            }

            <h4>Participants</h4>
            @for (participant of participants().controls; track $index; let i = $index) {
                <div>
                    <h5>Participant {{ i + 1 }}</h5>
                    <pre>
                Value: {{ participant.value | json }}
                Status: {{ participant.status | json }}
                Errors: {{ participant.errors | json }}
            </pre
                    >
                </div>
            }
        }

        @if (isSending) {
            <mat-progress-spinner class="example-margin" color="primary"> </mat-progress-spinner>
        }
    </form>
</div>
